<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BMI Distribution by State</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Segoe+UI&display=swap" rel="stylesheet">
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar">
    <div class="nav-brand"></div>
    <ul class="nav-links">
      <li><a href="{{ url_for('home_page') }}">Home</a></li>
      <li><a href="{{ url_for('bmi_page') }}">BMI Distribution</a></li>
      <li><a href="{{ url_for('about_page') }}">About</a></li>

    </ul>
  </nav>

  <!-- Main Content -->
  <main class="container">
    <h1>BMI Distribution by State</h1>
    <section class="controls">
      <label for="state-select">Select a state:</label>
      <select id="state-select">
        <option value="1">Alabama</option>
        <option value="2">Alaska</option>
        <option value="4">Arizona</option>
        <option value="5">Arkansas</option>
        <option value="6">California</option>
        <option value="8">Colorado</option>
        <option value="9">Connecticut</option>
        <option value="10">Delaware</option>
        <option value="11">District of Colombia</option>
        <option value="12">Florida</option>
        <option value="13">Georgia</option>
        <option value="15">Hawaii</option>
        <option value="16">Idaho</option>
        <option value="17">Illinois</option>
        <option value="18">Indiana</option>
        <option value="19">Iowa</option>
        <option value="20">Kansas</option>
        <option value="22">Louisiana</option>
        <option value="23">Maine</option>
        <option value="24">Maryland</option>
        <option value="25">Massachusetts</option>
        <option value="26">Michigan</option>
        <option value="27">Minnesota</option>
        <option value="28">Mississippi</option>
        <option value="29">Missouri</option>
        <option value="30">Montana</option>
        <option value="31">Nebraska</option>
        <option value="32">Nevada</option>
        <option value="33">New Hampshire</option>
        <option value="34">New Jersey</option>
        <option value="35">New Mexico</option>
        <option value="36">New York</option>
        <option value="37">North Carolina</option>
        <option value="38">North Dakota</option>
        <option value="39">Ohio</option>
        <option value="40">Oklahoma</option>
        <option value="41">Oregon</option>
        <option value="44">Rhode Island</option>
        <option value="45">South Carolina</option>
        <option value="46">South Dakota</option>
        <option value="47">Tennessee</option>
        <option value="48">Texas</option>
        <option value="49">Utah</option>
        <option value="50">Vermont</option>
        <option value="51">Virginia</option>
        <option value="53">Washington</option>
        <option value="54">West Virginia</option>
        <option value="55">Wisconsin</option>
        <option value="56">Wyoming</option>
        <option value="66">Guam</option>
        <option value="72">Puerto Rico</option>
        <option value="78">Virgin Islands</option>
    </select>
      <button id="update-button">Get BMI Data</button>
    </section>

    <section id="bmi-plot" class="card">
      <h2>Results</h2>
      <canvas id="bmiChart"></canvas>
    </section>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const button = document.getElementById("update-button");
      const stateSelect = document.getElementById("state-select");
      const ctx = document.getElementById("bmiChart").getContext("2d");
      let bmiChart; // to store the chart instance

      button.addEventListener("click", async () => {
      const state = stateSelect.value;
      const stateName = stateSelect.options[stateSelect.selectedIndex].text;

      try {
        const response = await fetch(`http://127.0.0.1:5000/api/bmi-distribution?state=${state}`);
        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();

        // Ensure results are always ordered 1 â†’ 4
        data.sort((a, b) => parseFloat(a._BMI5CAT) - parseFloat(b._BMI5CAT));

        // Map BMI codes to labels
        const categoryMap = {
          "1.0": { label: "Underweight", color: "#4bc0c0" }, // teal
          "2.0": { label: "Normal", color: "#36a2eb" },      // blue/green
          "3.0": { label: "Overweight", color: "#ffcd56" },  // yellow
          "4.0": { label: "Obese", color: "#ff6384" }        // red
        };

        const labels = data.map(item => categoryMap[item._BMI5CAT]?.label || item._BMI5CAT);
        const values = data.map(item => item.count);
        const colors = data.map(item => categoryMap[item._BMI5CAT]?.color || "#999999");

        if (bmiChart) {
          bmiChart.destroy();
        }

        bmiChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: `BMI Distribution`,
              data: values,
              backgroundColor: colors
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              title: {
                display: true,
                text: `BMI Distribution for ${stateName}`
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { stepSize: 1000 }
              }
            }
          }
        });

      } catch (error) {
        alert(`Error fetching data: ${error.message}`);
      }
    });
    });
  </script>

  <!-- Footer -->
  <footer>
    <p>&copy; 2025 BRFSS Health Analytics. All rights reserved.</p>
  </footer>
</body>
</html>
